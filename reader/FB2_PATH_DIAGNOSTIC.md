# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—É—Ç—è–º–∏ –∫ FB2 —Ñ–∞–π–ª–∞–º

## –ü—Ä–æ–±–ª–µ–º–∞
–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª FB2 "—É–µ—Ö–∞–ª –≤ —Å—Ç–æ—Ä–æ–Ω—É" - —Ñ–∞–π–ª –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –µ–≥–æ –Ω–∞–π—Ç–∏.

## –ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

```
–ü–†–û–ë–õ–ï–ú–ê: FB2 —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, —Ö–æ—Ç—è —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

–ö–û–ù–¢–ï–ö–°–¢:
1. –§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: reader/books/alice-wonderland.fb2
2. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤: reader/books/metadata.json —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ "file": "alice-wonderland.fb2"
3. BookService –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑: fetch('books/${bookData.file}')
4. reader.html –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (–∫–æ—Ä–µ–Ω—å –∏–ª–∏ –ø–æ–¥–ø–∞–ø–∫–∞)

–ó–ê–î–ê–ß–ê: –ù–∞–π—Ç–∏ –≥–¥–µ –∏–º–µ–Ω–Ω–æ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.

–ü–†–û–í–ï–†–ò–¢–¨:
1. –û—Ç–∫—É–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è reader.html? (–∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞ –∏–ª–∏ reader/ –ø–æ–¥–ø–∞–ø–∫–∞?)
2. –ö–∞–∫–æ–π –ø—É—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ fetch() - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π?
3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è bookUrl –≤ BookService.loadBook()?
4. –ï—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ø—É—Ç—è–º–∏ –¥–ª—è isServerBook –∏ –æ–±—ã—á–Ω—ã—Ö –∫–Ω–∏–≥?
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑–æ–≤—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã (window.location.pathname)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ LibraryView.loadMetadata() - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è isServerBook: true?
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage - –µ—Å—Ç—å –ª–∏ —Ç–∞–º –∑–∞–ø–∏—Å—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º file –∏ isServerBook?
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab - –∫–∞–∫–æ–π —Ä–µ–∞–ª—å–Ω—ã–π URL –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è?

–ì–ò–ü–û–¢–ï–ó–´:
A. –ü—É—Ç—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑-–∑–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ –æ—Ç reader.html
B. isServerBook –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
C. –§–∞–π–ª –≤ localStorage –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å
D. –ë–∞–∑–æ–≤—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ
E. CORS –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å fetch()

–ò–ù–°–¢–†–£–ú–ï–ù–¢–´:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å diagnostic-fb2-path.js –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Ç–µ–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏ 404
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage.getItem('reader-books')
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:

```javascript
// –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—É—Ç–µ–π –∫ FB2 —Ñ–∞–π–ª–∞–º
(async function() {
  console.log('%c=== FB2 PATH DIAGNOSTIC ===', 'font-size: 16px; font-weight: bold;');
  
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
  console.log('\nüìç Current Location:');
  console.log('  URL:', window.location.href);
  console.log('  Pathname:', window.location.pathname);
  console.log('  Base path:', window.location.pathname.split('/').slice(0, -1).join('/') || '/');
  
  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ metadata.json
  console.log('\nüìö Metadata Check:');
  try {
    const metaResponse = await fetch('books/metadata.json');
    console.log('  metadata.json status:', metaResponse.status, metaResponse.statusText);
    if (metaResponse.ok) {
      const meta = await metaResponse.json();
      console.log('  Books in metadata:', meta.books?.length || 0);
      meta.books?.forEach(book => {
        console.log(`    - ${book.id}: file="${book.file}"`);
      });
    }
  } catch (e) {
    console.error('  ‚ùå Failed to load metadata.json:', e.message);
  }
  
  // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
  console.log('\nüíæ LocalStorage Check:');
  const localBooks = JSON.parse(localStorage.getItem('reader-books') || '[]');
  console.log('  Books in localStorage:', localBooks.length);
  localBooks.forEach(book => {
    console.log(`    - ${book.id}:`, {
      file: book.file,
      isServerBook: book.isServerBook,
      hasFile: !!book.file
    });
  });
  
  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
  console.log('\nüîç File Path Check:');
  const testFiles = ['alice-wonderland.fb2'];
  for (const file of testFiles) {
    const paths = [
      `books/${file}`,
      `./books/${file}`,
      `/books/${file}`,
      `reader/books/${file}`
    ];
    
    for (const path of paths) {
      try {
        const response = await fetch(path, { method: 'HEAD' });
        console.log(`  ${path}:`, response.ok ? '‚úÖ' : `‚ùå ${response.status}`);
      } catch (e) {
        console.log(`  ${path}: ‚ùå ${e.message}`);
      }
    }
  }
  
  // 5. –°–∏–º—É–ª—è—Ü–∏—è BookService.loadBook()
  console.log('\n‚öôÔ∏è BookService Simulation:');
  const testBookId = 'alice-wonderland';
  const bookData = localBooks.find(b => b.id === testBookId);
  
  if (bookData) {
    console.log('  Found book:', bookData);
    let bookUrl;
    
    if (bookData.isServerBook) {
      bookUrl = `books/${bookData.file}`;
      console.log('  isServerBook=true, URL:', bookUrl);
    } else if (bookData.file) {
      bookUrl = `books/${bookData.file}`;
      console.log('  has file, URL:', bookUrl);
    } else {
      bookUrl = `books/${testBookId}.fb2`;
      console.log('  fallback, URL:', bookUrl);
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    try {
      const response = await fetch(bookUrl);
      console.log('  Fetch result:', response.ok ? '‚úÖ' : `‚ùå ${response.status} ${response.statusText}`);
      if (!response.ok) {
        console.log('  ‚ùå PROBLEM FOUND: File not accessible at', bookUrl);
        console.log('  Expected location: reader/books/alice-wonderland.fb2');
        console.log('  Current page location:', window.location.pathname);
      }
    } catch (e) {
      console.error('  ‚ùå Fetch error:', e.message);
    }
  } else {
    console.log('  ‚ùå Book not found in localStorage');
    console.log('  This means metadata.json was not loaded or book was not added');
  }
  
  // 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  console.log('\nüí° Recommendations:');
  const basePath = window.location.pathname.split('/').slice(0, -1).join('/') || '/';
  console.log('  Base path:', basePath);
  console.log('  If reader.html is in root: books/alice-wonderland.fb2 ‚úÖ');
  console.log('  If reader.html is in reader/: ../books/alice-wonderland.fb2 or books/alice-wonderland.fb2');
  
})();
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
**–°–∏–º–ø—Ç–æ–º:** 404 –æ—à–∏–±–∫–∞ –ø—Ä–∏ fetch('books/alice-wonderland.fb2')
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 2: isServerBook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
**–°–∏–º–ø—Ç–æ–º:** –ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage –∏–ª–∏ isServerBook: false
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å LibraryView.loadMetadata() - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –§–∞–π–ª –Ω–µ –≤ —Ç–æ–º –º–µ—Å—Ç–µ
**–°–∏–º–ø—Ç–æ–º:** –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø–æ –¥—Ä—É–≥–æ–º—É –ø—É—Ç–∏
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç—å

### –ü—Ä–æ–±–ª–µ–º–∞ 4: CORS –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∏ CORS –∏–ª–∏ 403
**–†–µ—à–µ–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ books/

