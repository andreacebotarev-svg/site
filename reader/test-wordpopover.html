<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPopover Test</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components/word-popover.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .interactive-word {
            cursor: pointer;
            color: var(--apple-blue);
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .interactive-word:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--card-bg);
        }
        .test-section h3 {
            margin-top: 0;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>WordPopover Test</h1>

        <div class="test-section">
            <h3>Click on words below to test WordPopover:</h3>
            <p>
                Click on <span class="interactive-word" data-word="hello">hello</span> or
                <span class="interactive-word" data-word="world">world</span> or
                <span class="interactive-word" data-word="test">test</span> to see the popover.
            </p>
            <p>
                Try clicking on <span class="interactive-word" data-word="vocabulary">vocabulary</span> and
                <span class="interactive-word" data-word="language">language</span> words.
            </p>
        </div>

        <div class="test-section">
            <h3>Debug Info:</h3>
            <div id="debug-info">
                <p>WordPopover initialization: <span id="init-status">Loading...</span></p>
                <p>API Status: <span id="api-status">Checking...</span></p>
                <p>Last clicked word: <span id="last-word">None</span></p>
            </div>
        </div>
    </div>

    <!-- WordPopover container -->
    <div id="word-popover-container"></div>

    <script type="module">
        // Test WordPopover functionality
        async function testWordPopover() {
            try {
                // Import WordPopover
                const { WordPopover } = await import('./assets/js/ui/components/WordPopover.js');

                const container = document.getElementById('word-popover-container');
                const wordPopover = new WordPopover(container);

                // Wait for initialization
                setTimeout(() => {
                    document.getElementById('init-status').textContent = '✅ Initialized';
                }, 1000);

                // Test API connectivity
                testAPIConnectivity();

                // Add click handlers to test words
                document.querySelectorAll('.interactive-word').forEach(wordEl => {
                    wordEl.addEventListener('click', (e) => {
                        e.stopPropagation();

                        const word = wordEl.dataset.word;
                        const rect = wordEl.getBoundingClientRect();

                        document.getElementById('last-word').textContent = word;

                        console.log('Clicked word:', word, 'Rect:', rect);

                        // Show popover - check parameter order
                        wordPopover.show(wordEl, rect, word);
                    });
                });

                // Global access for debugging
                window.testWordPopover = wordPopover;
                window.testContainer = container;

                console.log('WordPopover test initialized');

            } catch (error) {
                console.error('Failed to initialize WordPopover test:', error);
                document.getElementById('init-status').textContent = '❌ Error: ' + error.message;
            }
        }

        async function testAPIConnectivity() {
            const statusEl = document.getElementById('api-status');

            try {
                // Test Dictionary API
                const dictResponse = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/hello', {
                    signal: AbortSignal.timeout(5000)
                });

                if (dictResponse.ok) {
                    statusEl.innerHTML = '✅ Dictionary API working';
                } else {
                    statusEl.innerHTML = '⚠️ Dictionary API returned ' + dictResponse.status;
                }
            } catch (error) {
                console.warn('Dictionary API test failed:', error);
                statusEl.innerHTML = '❌ Dictionary API failed: ' + error.message;

                // Try Google Translate as fallback
                try {
                    const translateResponse = await fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ru&dt=t&q=test', {
                        signal: AbortSignal.timeout(5000)
                    });

                    if (translateResponse.ok) {
                        statusEl.innerHTML += '<br>✅ Google Translate API working';
                    }
                } catch (translateError) {
                    statusEl.innerHTML += '<br>❌ Google Translate API also failed';
                }
            }
        }

        // Handle console logs for debugging
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage('LOG', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToPage('WARN', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToPage('ERROR', ...args);
        };

        function logToPage(level, ...args) {
            const debugInfo = document.getElementById('debug-info');
            const logEntry = document.createElement('p');
            logEntry.style.cssText = `
                font-family: monospace;
                font-size: 12px;
                margin: 4px 0;
                padding: 4px;
                background: ${level === 'ERROR' ? '#fee' : level === 'WARN' ? '#fff8e1' : '#f0f9ff'};
                border-left: 3px solid ${level === 'ERROR' ? '#e11' : level === 'WARN' ? '#f59e0b' : '#3b82f6'};
            `;
            logEntry.textContent = `[${level}] ${args.join(' ')}`;
            debugInfo.appendChild(logEntry);
        }

        // Start test
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', testWordPopover);
        } else {
            testWordPopover();
        }
    </script>
</body>
</html>
